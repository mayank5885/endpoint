[
    {
        "filename": "AtlassianJiraAudit_ccpv2/JiraAudit_PollingConfig.json",
        "content": {
            "name": "AtlassianJiraCCPPolling",
            "apiVersion": "2022-12-01-preview",
            "type": "Microsoft.SecurityInsights/dataConnectors_wrongElementAdded",
            "location": "{{location}}",
            "kind": "RestApiPoller",
            "properties": {
                "connectorDefinitionName": "JiraAuditCCPDefinition",
                "dataType": "Jira_Audit_v2_CL",
                "dcrConfig": {
                    "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
                    "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}",
                    "streamName": "Custom-Jira_Audit_v2_CL"
                },
                "auth": {
                    "type": "Basic",
                    "UserName": "{{userid}}",
                    "Password": "{{apikey}}"
                },
                "request": {
                    "apiEndpoint": "https://{{jiraorganizationurl}}/rest/api/3/auditing/record",
                    "httpMethod": "GET",
                    "retryCount": 3,
                    "timeoutInSeconds": 60,
                    "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
                    "headers": {
                        "Accept": "application/json",
                        "User-Agent": "Scuba"
                    },
                    "startTimeAttributeName": "from",
                    "endTimeAttributeName": "to"
                },
                "paging": {
                    "pagingType": "Offset",
                    "offsetParaName": "offset",
                    "pageSizeParaName": "limit",
                    "pageSize": 1000
                },
                "response": {
                    "eventsJsonPaths": [
                        "$.records"
                    ],
                    "format": "json"
                }
            }
        }
    },
    {
        "filename": "ErmesBrowserSecurityEvents_ccp/data_connector_definition.json",
        "content": {
            "type": "Microsoft.SecurityInsights/dataConnectorDefinitions",
            "apiVersion": "2022-09-01-preview",
            "name": "ErmesBrowserSecurityEvents",
            "location": "{{location}}",
            "kind": "Customizable",
            "properties": {
                "connectorUiConfig": {
                    "id": "ErmesBrowserSecurityEvents",
                    "title": "Ermes Browser Security Events",
                    "publisher": "Ermes Cyber Security S.p.A.",
                    "descriptionMarkdown": "Ermes Browser Security Events",
                    "graphQueriesTableName": "ErmesBrowserSecurityEvents_CL",
                    "graphQueries": [
                        {
                            "metricName": "Total events received",
                            "legend": "Ermes Events",
                            "baseQuery": "{{graphQueriesTableName}}"
                        }
                    ],
                    "sampleQueries": [
                        {
                            "description": "Get Sample of Ermes Events",
                            "query": "{{graphQueriesTableName}}\n | take 10"
                        }
                    ],
                    "dataTypes": [
                        {
                            "name": "{{graphQueriesTableName}}",
                            "lastDataReceivedQuery": "{{graphQueriesTableName}}\n | where TimeGenerated > ago(12h) | where name_s == \"no data test\" | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
                        }
                    ],
                    "connectivityCriteria": [
                        {
                            "type": "HasDataConnectors"
                        }
                    ],
                    "availability": {
                        "isPreview": False
                    },
                    "permissions": {
                        "resourceProvider": [
                            {
                                "provider": "Microsoft.OperationalInsights/workspaces",
                                "permissionsDisplayText": "Read and Write permissions are required.",
                                "providerDisplayName": "Workspace",
                                "scope": "Workspace",
                                "requiredPermissions": {
                                    "write": True,
                                    "read": True,
                                    "delete": True
                                }
                            },
                            {
                                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                                "permissionsDisplayText": "Read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key)",
                                "providerDisplayName": "Keys",
                                "scope": "Workspace",
                                "requiredPermissions": {
                                    "action": True
                                }
                            }
                        ],
                        "customs": [
                            {
                                "name": "Ermes Client Id and Client Secret",
                                "description": "Enable API access in Ermes. Please contact [Ermes Cyber Security](https://www.ermes.company) support for more information."
                            }
                        ]
                    },
                    "instructionSteps": [
                        {
                            "description": "Connect using OAuth2 credentials",
                            "instructions": [
                                {
                                    "type": "OAuthForm",
                                    "parameters": {
                                        "clientIdLabel": "Client ID",
                                        "clientSecretLabel": "Client Secret",
                                        "connectButtonLabel": "Connect",
                                        "disconnectButtonLabel": "Disconnect"
                                    }
                                }
                            ],
                            "title": "Connect Ermes Browser Security Events to Microsoft Sentinel"
                        }
                    ]
                }
            }
        }
    },
    {
        "filename": "ErmesBrowserSecurityEvents_ccp/data_connector_poller.json",
        "content": [
            {
                "type": "Microsoft.SecurityInsights/dataConnectors",
                "apiVersion": "2022-10-01-preview",
                "name": "ErmesBrowserSecurityEvents",
                "kind": "RestApiPoller",
                "properties": {
                    "connectorDefinitionName": "ErmesBrowserSecurityEvents",
                    "dataType": "ErmesBrowserSecurityEvents_CL",
                    "dcrConfig": {
                        "streamName": "Custom-Ermes_ClientCredentials",
                        "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
                        "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}"
                    },
                    "auth": {
                        "type": "OAuth2",
                        "ClientSecret": "{{clientSecret}}",
                        "ClientId": "{{clientId}}",
                        "GrantType": "client_credentials",
                        "TokenEndpoint": "https://api.shield.ermessecurity.com/oauth/token",
                        "TokenEndpointHeaders": {
                            "Content-Type": "application/x-www-form-urlencoded"
                        },
                        "TokenEndpointQueryParameters": {}
                    },
                    "request": {
                        "apiEndpoint": "https://api.shield.ermessecurity.com/public/v1/events",
                        "httpMethod": "GET",
                        "queryParameters": {
                            "max_results": 100,
                            "sort": "-_created",
                            "is_azure": "[variables('_solutionVersion')]"
                        },
                        "queryWindowInMin": 5,
                        "queryTimeFormat": "yyyy-MM-ddTHH:mm:ss.000000+00:00",
                        "startTimeAttributeName": "gte__created",
                        "endTimeAttributeName": "lt__created",
                        "rateLimitQps": 1,
                        "retryCount": 3,
                        "timeoutInSeconds": 30,
                        "headers": {
                            "Accept": "application/json",
                            "User-Agent": "Scuba"
                        }
                    },
                    "response": {
                        "eventsJsonPaths": [
                            "$._items[*]"
                        ]
                    },
                    "paging": {
                        "pagingType": "LinkHeader"
                    }
                }
            }
        ]
    },
    {
        "filename": "ErmesBrowserSecurityEvents_ccp/dcr.json",
        "content": [
            {
                "name": "ErmesOauthDCR1",
                "apiVersion": "2021-09-01-preview",
                "type": "Microsoft.Insights/dataCollectionRules",
                "location": "{{location}}",
                "properties": {
                    "dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
                    "streamDeclarations": {
                        "Custom-Ermes_ClientCredentials": {
                            "columns": [
                                {
                                    "name": "_created",
                                    "type": "string",
                                    "description": "Event Timestamp"
                                },
                                {
                                    "name": "username",
                                    "type": "string",
                                    "description": "Username"
                                },
                                {
                                    "name": "client_ip",
                                    "type": "string",
                                    "description": "Client IP"
                                },
                                {
                                    "name": "level",
                                    "type": "string",
                                    "description": "Event priority level (INFO, WARNING, etc)"
                                },
                                {
                                    "name": "event_cat",
                                    "type": "string",
                                    "description": "Event Category"
                                },
                                {
                                    "name": "event_id",
                                    "type": "string",
                                    "description": "Event Id"
                                },
                                {
                                    "name": "message",
                                    "type": "dynamic",
                                    "description": "Message"
                                }
                            ]
                        }
                    },
                    "destinations": {
                        "logAnalytics": [
                            {
                                "workspaceResourceId": "{{workspaceResourceId}}",
                                "name": "clv2ws1"
                            }
                        ]
                    },
                    "dataFlows": [
                        {
                            "streams": [
                                "Custom-Ermes_ClientCredentials"
                            ],
                            "destinations": [
                                "clv2ws1"
                            ],
                            "transformKql": "source | project TimeGenerated = todatetime([\"_created\"]), Username = username, ClientIP = client_ip, EventCategory = event_cat, EventId = event_id, Level = level, Message = tostring(message.en)",
                            "outputStream": "Custom-ErmesBrowserSecurityEvents_CL"
                        }
                    ]
                }
            }
        ]
    },
    {
        "filename": "ErmesBrowserSecurityEvents_ccp/table.json",
        "content": [
            {
                "name": "ErmesBrowserSecurityEvents_CL",
                "type": "Microsoft.OperationalInsights/workspaces/tables",
                "apiVersion": "2021-03-01-privatepreview",
                "tags": {},
                "properties": {
                    "schema": {
                        "name": "ErmesBrowserSecurityEvents_CL",
                        "columns": [
                            {
                                "name": "TimeGenerated",
                                "type": "Datetime",
                                "isDefaultDisplay": True,
                                "description": "The timestamp (UTC) reflecting the time in which the event was generated."
                            },
                            {
                                "name": "Username",
                                "type": "String",
                                "description": "Username"
                            },
                            {
                                "name": "ClientIP",
                                "type": "String",
                                "description": "Client IP"
                            },
                            {
                                "name": "Level",
                                "type": "String",
                                "description": "Event priority level (INFO, WARNING, etc)"
                            },
                            {
                                "name": "EventCategory",
                                "type": "String",
                                "description": "Event Category"
                            },
                            {
                                "name": "EventId",
                                "type": "String",
                                "description": "Event Id"
                            },
                            {
                                "name": "Message",
                                "type": "String",
                                "description": "Message"
                            }
                        ]
                    }
                }
            }
        ]
    },
    {
        "filename": "GoogleCloudPlatformAudit Logs_ccp/data_connector_poller.json",
        "content": [
            {
                "type": "Microsoft.SecurityInsights/dataConnectors_wrongElementAdded",
                "apiVersion": "2022-10-01-preview",
                "name": "{{workspace}}/Microsoft.SecurityInsights/GCPAuditLogs",
                "kind": "GCP",
                "properties": {
                    "connectorDefinitionName": "GCPAuditLogsDefinition",
                    "dataType": "GCPAuditLogs",
                    "dcrConfig": {
                        "streamName": "SENTINEL_GCP_AUDIT_LOGS"
                    },
                    "auth": {
                        "serviceAccountEmail": "{{GCPServiceAccountEmail}}",
                        "projectNumber": "{{GCPProjectNumber}}",
                        "workloadIdentityProviderId": "{{GCPWorkloadIdentityProviderId}}"
                    },
                    "request": {
                        "projectId": "{{GCPProjectId}}",
                        "subscriptionNames": [
                            "{{GCPSubscriptionName}}"
                        ]
                    }
                }
            }
        ]
    }
]